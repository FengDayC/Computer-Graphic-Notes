# 动机
将机器学习用到光照探针上面来，具体来说，先预计算一个高分辨率的辐射场，然后用这个预计算的辐射场来训练网络，在实时渲染的时候，给网络一个位置和方向作为输入，得到相应的辐照度输出。
# 方法
## 探针神经权重
辐照度探针将辐照度保存在区域结点中，区域内的着色点通过探针插值得到辐照度：
$$
\hat{L}(x)=\sum_{p\in P}h_p(x)L_p
$$
一般来说，插值权重需要考虑可见性问题，文章方法将插值权重交给神经网络预测：
$$
\hat{L}(x)=\frac{\sum_{p\in P}\Phi_p(x)L_p}{\sum_{p\in P}\Phi_p(x)}
$$
优化这一误差即：
$$
\underset{L_p,\Phi_p,\theta}{argmin}\int_S \mathcal{L}(L(x),\hat{L}(x))
$$
文章用了sMAPE损失。
## 局部权重
上述探针权重是在全局空间下训练的(所有的空间区域都使用同一个神经网络进行预测)，当事实上，每个着色点只对包围这一点的几个探针进行插值。这就网络训练时意味着局部的误差会影响到全局的参数更新，导致更新缓慢。
事实上，可以为每个探针生成对应的权重函数，这样一来，探针之间互不影响，也就可以进行并行生成。具体来说，就是在每个探针周围的空间中随机采样一些支持点，用这些支持点来优化这个探针的权重函数。
## 权重函数表示
文章采用了两种权重函数表示，一种是通过一个体积场来表示，一种是通过神经网络来表示。
为了表示在权重硬边界上的不连续性，本论文采用一个增强版的ReLU Field[[ReLU Fields: The Little Non-linearity That Could]]来表示权重，ReLU Field被表示如下：
$$
reluField(G,x)=min(1,max(0,f(G,x)))
$$
$G$是一个函数的网格表示，函数$f$表示获取离$x$最近的$G$上的值并且插值的结果。
增强后的ReLU Field被称为Product Field，如下：
$$
productField(G,H,x)=min(1,max(0,f(G,x)))\sigma(f(H,x))
$$
$H$为补充函数的网格表示。引入补充函数的原因是为了拟合信号的连续部分，也就是ReLU负责不连续而补充部分负责连续部分。这两个网格可以分辨率不同，并可以进行联合优化。为了优化过程的稳定性(梯度的稳定),将补充函数的采样进行一个sigmoid(即上式的$\sigma$)。
神经网络表示如下：
![](1.png)
## 生成网络
对于权重函数的训练，一个朴素的想法是直接计算L2 Loss进行优化，但在生产中，游戏场景往往有特别多的探针，如果直接训练的话会造成特别大的时间开销。文章**使用了一个生成网络来直接生成每个探针的最佳参数**。
生成网络接受一个探针的权重函数的参数作为输入，直接输出优化好的权重函数参数(相当于用一个函数直接取代了网络迭代训练的过程)。在应用中，由于生成网络的输入维度有限，需要将权重函数的参数使用PCA进行投影以降维。
生成网络需要进行预训练，但与直接优化每个探针的权重函数不同，生成网络不需要对于每个探针进行训练，而是只需要进行一次训练就可以泛用到所有探针的权重函数生成上。
生成网络使用了一个带残差的MLP来进行，每一层使用LeakyReLU激活函数:
![](2.png)
## Pipeline
整个方法的pipeline总结如下图：
![](3.png)
输入一个从一些离散的点生成的权重函数，使用生成网络每个探针的生成权重函数表示网络，利用这个权重函数网络来预测辐照度。对于需要精细的区域，可以进一步优化生成的这个权重函数网络。
# 实现
## 探针布置
探针使用一个两层的均匀分布。第一层的每个点都保存一个权重函数，并且有一些点保存一个细均匀网格体积。细均匀网格体积内包含多个探针，总的权重是顶层权重+底层权重进行插值并归一化得到。
![](4.png)
## 权重函数初始化
权重函数的初始化由以下步骤进行：
1. 撒点:在场景内播撒"支持点"，用于采样并生成权重函数
2. 烘焙"支持点":对于每个"支持点"，计算是否合法(是否在几何体之外)以及计算其收到的radiance。
3. 扩散生成权重:对于那些对中心probe可见的支持点，直接赋予三线性插值权重。接着，每个点与它的邻居基于相互的距离以及他们的radiance差值进行权重调整。当所有的权重计算出来的时候，探针收到的radiance通过对其区域内的支持点求和得到。
# 总结
## 局限性
+ 局限于探针的稀疏性，对于一些小距离变化剧烈的几何来说拟合效果不佳，可能漏光
+ 查询结构的花费很高，对于需要逐像素查询的情况下可能会性能下降
## 主要贡献
+ 提出了product field来拟合辐照度场
+ 提出了generator network来生成探针权重