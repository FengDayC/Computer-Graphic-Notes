# 思想
PPG的最终目标是对渲染方程进行重要性采样:
![](论文/Path%20Guiding/pics/1.png)
换句话说，就是需要得到一个概率密度函数正比于光照、BSDF和余弦项的乘积。PPG忽略BSDF，通过光场的近似得到这一个近似的概率密度函数。
# 渲染过程
迭代过程首先将概率场景上每个点的概率密度函数设置为均匀分布函数，并进行渲染。每次渲染将光路经过的点的radiance记录在一个空间-方向树上，并且下一次渲染根据这个树记录的radiance更新概率密度函数，并用这一新的概率密度函数来引导路径。每一次渲染可以得到一张图像，越后面的迭代中得到的图像方差越小。因此有两种策略来将多次渲染的图像进行混合：一是每次迭代的spp加倍，因此后面的轮次中采样次数更多;二是使用一个逐次增加的权重对所有的图像进行混合，使得方差小的图像有更大的权重。
![](论文/Path%20Guiding/pics/2.png)
![](论文/Path%20Guiding/pics/3.png)
# 树的更新和查询
对于每一个新的采样点，我们可以将其插入到八叉树中，查询时查询采样点对应区域的信息，这样就相当于做了一个最近邻插值。这样做的话，效果不是很好，会产生光照不够平滑的artifact。
为了解决这一问题，可以通过对这一八叉树进行滤波。具体来说，在进行查询时，不止查询着色点所在的结点，还做一个最近邻搜索，将临近的结点一起信息一起纳入考虑。这样的方法可能导致一个问题，就是一个很大的结点附近有一个很高分辨率的结点，则其具有多个邻居导致计算时间上升。
为了解决这一问题，可以通过一定的概率去随机的访问临近结点。
![](论文/Path%20Guiding/pics/4.png)
对于空间维度可以如上所述做滤波，对于方向维度也可以同样做滤波。
![](论文/Path%20Guiding/pics/5.png)
# BSDF采样
传统的路径引导渲染器会使用MIS来选择是进行BSDF采样还是引导分布采样，通常分为两步，首先通过一些启发式方法决定所有采样的权重，然后再决定有多少采样点使用BSDF采样。
事实上，这一方法可以总结为对BSDF采样的概率密度和对引导概率密度做一个线性插值，并且希望这一线性插值能够去逼近”理想“的采样概率密度，即：
$$
p_{final}(\omega_i,\alpha)=\alpha p_{BSDF}(\omega_i)+(1-\alpha)p_{guide}(\omega_i)\propto L(\omega_i)f(\omega_i)cos(\theta_i)=p_{ideal}(\omega_i)
$$
事实上，这一问题是求最优的$\alpha$，可以转化为一个优化问题：
$$
\text{Mininize:}D(p_{ideal}||p_{final};\alpha)\alpha\in[0,1]
$$
这里的$D$取KL散度的情况下，可以采用如下的随机梯度下降法来解决。
梯度如下：
$$
-\frac{L(\omega_i)f(\omega_i)cos(\theta_i)}{p_{final}(\omega_i,\alpha)}\cdot\frac{p_{BSDF}(\omega_i)-p_{guide}(\omega_i)}{p_{final}(\omega_i,\alpha)}
$$
使用Adam估计器的算法伪代码如下：
![](论文/Path%20Guiding/pics/6.png)
