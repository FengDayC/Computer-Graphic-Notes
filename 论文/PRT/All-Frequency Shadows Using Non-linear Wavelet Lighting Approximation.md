# 摘要
使用小波作为基函数来表达一个有cubemap形式给出的环境光照，从而进行relighting的计算。实现了比球谐函数更为快速，并且能够保存全频率信息的光照计算。
# 数学依据
论文处理了两种情况：
+ Geometry Relighting：视角改变但场景中只有漫反射材质
+ Image Relighting：视角不变但可以有Glossy材质并且可以处理间接光传播效果
只考虑环境光照的渲染方程可以写作如下形式：
![](论文/PRT/pics/1.png)
对于Geometry Relighting来说，由于BRDF只与着色点位置有关，因此可以将渲染方程中的传播项写为：
![](论文/PRT/pics/2.png)
对于Image Relighting来说，由于视角不变，可以将$\mathbf{\omega}_o$视为着色点位置的函数，因此有：
![](论文/PRT/pics/3.png)
由于传播项只与着色点位置和光线入射方向有关，因此确定了着色点，只需对入射方向积分即可：
![](论文/PRT/pics/4.png)
写成矩阵形式：
![](论文/PRT/pics/5.png)
$\mathbf{T}$为光传播矩阵，其中的每一列表示一个光线方向（或者说是以环境贴图上一个像素点作为光源），每一行表示一个着色点
# 算法实现
## 预计算
论文只计算了一次直接光照的光传播（受图形硬件限制，用光栅化实现），将其保存在$T$中
### 传播矩阵计算
直接计算矩阵的每一行（即每一个着色点）的所有方向上的传播信息，并投影到小波基上成为一个个系数
### 存储
先将系数规定到一定的位数，然后舍弃所有为0的系数，最后使用稀疏矩阵的存储方式将其存起来
## 渲染
### 环境光变换
对cubemap的每个面做2维小波变换，这样可以得到一系列的基系数，渲染时则根据一定的规则来选定一些基系数来恢复光照
选定基的规则有以下几种可能：
+ 直接选系数最大的基：这样可以最小化$L^2$误差，但可能不一定能够实现渲染的最小误差
+ 根据$\mathbf{T}$来选：先预计算出着色点被单个光照亮时所接收到的能量，渲染时选择最大的能量的基来恢复
+ 根据区域来选，选择占据最大区域的基函数来恢复（论文选用）
# 结果
## 光源信息的恢复
与球谐函数在光源近似上的$L^2$误差的比较
![](论文/PRT/pics/6.png)
可以看到，小波方法远比球谐函数在光源近似上的L2误差小
## 辐射度计算的恢复
对辐射度的近似采用了两个评估标准，一个是$L^2$误差，一个是$H^1$范数，用于衡量边界处的阴影近似程度
![H1范数](论文/PRT/pics/7.png)
![](论文/PRT/pics/8.png)
可以看到在1000项左右小波的图像误差就已经小到几乎不存在
