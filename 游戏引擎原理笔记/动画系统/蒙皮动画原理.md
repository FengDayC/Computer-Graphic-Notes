# 蒙皮动画原理

## 基本组成
整个刚体由蒙皮和里面的骨骼组成，蒙皮上的每个节点有一个受骨骼影响的权重。当骨骼运动的时候蒙皮的顶点位置根据权重和骨骼位置来计算。

## 骨骼
+ “骨骼”实际上存储的是关节的变换数据，两个关节之间的部位定义为骨骼
+ 类人生物骨骼：骨骼的中心点在跨部，向上生出整个躯干，向下生出两条腿
+ 拿取武器、骑乘等动作的实现一般可以将武器、载具的关节绑在人的相应关节上，形成一个整体作为绑定动画
+ ROOT关节：位于角色的最低点，控制人行走的高度等，可以准确的表达人物位置
+ T-Pose和A-Pose：用于进行骨骼的绑定，T-Pose可能会压缩肩膀处造成精度不够，业界越来越多开始用A-Pose

## Joint
1. 仿射矩阵：Joint的姿态由三个要素组成，旋转、平移、缩放，最后用三个要素的矩阵相乘来表示Joint的姿态
$$
M=RTS= \begin {bmatrix} SR & T \\ 0 & 1 \end{bmatrix}
$$
2. 从仿射矩阵到到模型矩阵的方法：从根节点开始，所有的祖先节点的仿射矩阵相乘，最后乘上该节点的仿射矩阵
$$ M^m_J = \Pi^0_{j=J} M^l_{p(j)} $$
3. 骨骼插值：用局部坐标系而非模型坐标系

## Skinning Matrix
### 单关节绑定的Skinning Matrix
对于只有一个关节的情况，蒙皮上的点和关节的数学关系如下
$$
\begin{aligned}
V_b^m:绑定时顶点的模型空间坐标 \\ 
V^l_b:绑定时顶点的局部空间坐标 \\ 
V^l(t):t时刻的顶点局部空间坐标 \\
M^m_J:绑定的关节的模型空间矩阵 \\
M^m_J(t):t时刻关节的模型空间矩阵
\end{aligned}
$$
当顶点绑定到骨骼上的时候，满足恒等式：
$$ V^l(t)=V^l_b=(M^m_J)^{-1} \cdot V^m_b $$
即计算顶点位置时，有：
$$ V^m_b=M^m_J \cdot V^l(t) $$
t时刻计算顶点坐标为：
$$V^m(t)=M^m_J(t)=[M^m_J(t)\cdot (M^m_J)^{-1}]\cdot V_b^m$$
以上记中括号内为Skining Matrix，即：
$$Skinning\ Matrix:K_J=M^m_J(t)\cdot(M_J^m)^{-1}$$
### 引擎中的Skinning Matrix
游戏引擎中使用时，一般会预处理每一个关节的Skinning Matrix，并且将此矩阵转换到世界坐标系当中

## 权重
每一个顶点受不止一个Joint的影响，同一个顶点满足所有权重之和为1
$$ \sum W_i=1$$
进行计算时，先分别计算顶点关于每一个Joint的模型空间坐标，再根据权重插值
$$ \begin{aligned}
V^m_{J(i)}(t)=K_{J(i)}(t) \cdot V^m_{bJ(i)} \\
V^m(t)=\sum ^{N-1}_0 W_i\cdot V^m_{J(i)}(t)
\end{aligned}$$
